<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesos Activos | VotUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-50">

    <!-- HEADER -->
    <header class="bg-teal-700 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="logo.jpg" alt="VotUP Logo" class="w-10 h-10 rounded-lg"> 
                <span id="welcome-message" class="text-white font-semibold hidden text-lg"></span>
            </div>
            <button id="logout-btn" class="bg-white text-teal-700 font-bold py-2 px-5 rounded-lg shadow-md hover:bg-gray-200 transition duration-300">
                <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
            </button>
        </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-16 text-center">

        <h2 class="text-4xl font-extrabold text-gray-800 mb-12">
            Selecciona un Proceso Electoral
        </h2>

        <section id="procesos-section">
            <div id="procesos-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
            
            <p id="loading-message" class="text-gray-500 text-xl mt-16">Cargando procesos activos...</p>
        </section>

        <!-- MENSAJE DE ERROR DE AUTENTICACIÓN -->
        <div id="auth-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-16 shadow-lg max-w-lg mx-auto" role="alert">
            <strong class="font-bold block text-lg mb-2">Acceso Denegado</strong>
            <span class="block text-base">Debe iniciar sesión para ver los procesos electorales y participar en la votación.</span>
            <div class="mt-4">
                <a href="index.html" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    Iniciar Sesión
                </a>
            </div>
        </div>

    </main>

    <!-- SCRIPT -->
    <script>
        const API_URL = 'https://sistema-de-votacion-gjzq.onrender.com'; 
        const USER_TOKEN = localStorage.getItem('token');

        const procesosContainer = document.getElementById('procesos-container');
        const loadingMessage = document.getElementById('loading-message');
        const authErrorMessage = document.getElementById('auth-error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeMessage = document.getElementById('welcome-message');

        function decodeToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch { return null; }
        }

        function logoutHandler(e) {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user'); 
            alert("Sesión cerrada. Redirigiendo a la página de inicio.");
            window.location.href = 'index.html';
        }

        function createProcesoCard(proceso) {
            const card = document.createElement('a');
            card.href = `candidatos.html?procesoId=${proceso._id}`; 
            card.className = `
                flex flex-col items-center p-6 bg-white rounded-2xl shadow-lg hover:shadow-2xl 
                transition duration-300 transform hover:-translate-y-2
            `;
            card.innerHTML = `
                <div class="w-24 h-24 md:w-28 md:h-28 bg-teal-100 rounded-full flex items-center justify-center mb-4 border-4 border-teal-500">
                    <i class="fas fa-vote-yea text-5xl md:text-6xl text-teal-600"></i>
                </div>
                <p class="text-xl font-bold text-gray-800 text-center mb-1">${proceso.nombre}</p>
                <p class="text-sm font-medium text-gray-500 mb-3">${proceso.tipo}</p>
                <span class="mt-2 text-xs font-semibold text-green-700 bg-green-100 px-3 py-1 rounded-full">
                    ACTIVO
                </span>
            `;
            return card;
        }

        async function loadProcesosActivos() {
            if (!procesosContainer || !loadingMessage) return;

            try {
                const res = await fetch(`${API_URL}/api/usuario/procesos-activos`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${USER_TOKEN}` }
                });
                
                if (res.status === 401 || res.status === 403) {
                    alert("Su sesión ha expirado o no tiene permisos. Inicie sesión de nuevo.");
                    localStorage.clear();
                    window.location.href = 'index.html'; 
                    return;
                }

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Fallo en la carga de procesos.');

                loadingMessage.classList.add('hidden'); 

                if (data.length > 0) {
                    data.forEach(proceso => procesosContainer.appendChild(createProcesoCard(proceso)));
                } else {
                    procesosContainer.innerHTML = '<p class="text-xl text-gray-500 col-span-full mt-10">No hay procesos electorales activos en este momento.</p>';
                }

            } catch (err) {
                console.error("Error al cargar procesos:", err);
                loadingMessage.textContent = "Error de conexión con el servidor. Por favor, inténtelo de nuevo.";
                loadingMessage.classList.remove('hidden');
            }
        }

        window.onload = function() {
            if (!USER_TOKEN) {
                document.getElementById('procesos-section').classList.add('hidden');
                logoutBtn.classList.add('hidden');
                authErrorMessage.classList.remove('hidden');
                return;
            }

            const userData = decodeToken(USER_TOKEN);
            const userName = userData && userData.nombre ? userData.nombre.split(' ')[0] : (userData && userData.id ? 'Votante' : 'Usuario');

            welcomeMessage.textContent = `Bienvenido, ${userName}`;
            welcomeMessage.classList.remove('hidden');
            
            if (logoutBtn) logoutBtn.addEventListener('click', logoutHandler);
            
            loadProcesosActivos();
        };
    </script>

</body>
</html>