<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - Panel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-bg': '#f3f4f6', 
                        'sidebar-bg': '#3c676e', 
                        'main-title': '#2e4963', 
                        'sidebar-btn-active': '#e5e7eb', 
                        'custom-dark-button': '#355b63',
                        'vote-color-1': '#dc2626', 
                        'vote-color-2': '#4f6a73', 
                        'vote-color-3': '#6b21a8',
                    },
                    spacing: {
                        'sidebar-width': '16rem',
                    }
                }
            }
        }

        const API_URL = "https://sistema-de-votacion-gjzq.onrender.com/api";

        let selectedProcess = ''; 

        function drawPieChart(data) {
            const canvas = document.getElementById('vote-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const total = data.reduce((sum, item) => sum + item.percentage, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.8;
            let currentAngle = 0;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Colores automáticos para cada candidato
            const colores = ['#dc2626', '#4f6a73', '#6b21a8', '#f59e0b', '#10b981', '#3b82f6'];

            data.forEach((slice, index) => {
                const sliceAngle = (slice.percentage / total) * (Math.PI * 2);
                const fillColor = colores[index % colores.length];

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();

                ctx.fillStyle = fillColor;
                ctx.fill();

                currentAngle += sliceAngle;
            });
        }

        function updateResults(processName, result) {
            selectedProcess = processName;
            document.getElementById('current-process-name').textContent = processName;

            drawPieChart(result.votos);

            const legendContainer = document.getElementById('chart-legend');
            let legendHtml = '';
            const colores = ['#dc2626', '#4f6a73', '#6b21a8', '#f59e0b', '#10b981', '#3b82f6'];
            result.votos.forEach((voto, index) => {
                const color = colores[index % colores.length];
                legendHtml += `
                    <div class="flex items-center space-x-2 text-sm text-gray-700">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${color};"></span>
                        <span class="font-medium">${voto.candidate}:</span>
                        <span>${voto.percentage}%</span>
                    </div>
                `;
            });
            legendContainer.innerHTML = legendHtml;
        }

        function toggleFilterList() {
            document.getElementById('filter-process-list').classList.toggle('hidden');
        }

        function renderFilterList(procesos) {
            const list = document.getElementById('filter-process-list');
            list.innerHTML = procesos.map(p => `
                <a href="#" onclick="selectProcess('${p.id}', '${p.nombre}'); return false;" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-100">
                    ${p.nombre}
                </a>
            `).join('');
        }

        async function selectProcess(procesoId, procesoNombre) {
            try {
                const token = localStorage.getItem("token");
                const res = await fetch(`${API_URL}/resultados/${procesoId}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const data = await res.json();
                updateResults(procesoNombre, data); 
                toggleFilterList();
                updateFilterDisplay();
            } catch (err) {
                console.error("Error al cargar resultados:", err);
            }
        }

        function updateFilterDisplay() {
            document.getElementById('filter-input').value = selectedProcess;
        }

        async function cargarProcesos() {
            try {
                const token = localStorage.getItem("token");
                const res = await fetch(`${API_URL}/proceso`);
                const data = await res.json();

                const procesosFiltrados = data.filter(p => p.estado === "Activo" || p.estado === "Terminado");
                renderFilterList(procesosFiltrados.map(p => ({ id: p._id, nombre: p.nombre })));
            } catch (err) {
                console.error("Error cargando procesos:", err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            cargarProcesos();
        });
    </script>

</head>
<body class="bg-main-bg font-sans">
    <div class="flex min-h-screen">
        <div class="w-sidebar-width bg-sidebar-bg text-white flex flex-col justify-between p-4 fixed h-full shadow-lg">
            <div>
                <div class="flex items-center space-x-3 mb-8 border-b border-gray-500 pb-4">
                    <div class="p-2 rounded-full bg-white text-sidebar-bg">
                        <i class="fas fa-user text-xl"></i>
                    </div>
                    <span id="nombreAdmin" class="text-xl font-semibold">Usuario</span>
                </div>

                <nav class="space-y-3">
                    <a href="principal.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-home w-5 h-5"></i>
                        <span>Panel principal</span>
                    </a>
                    <a href="procesos-electorales.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-clipboard-list w-5 h-5"></i>
                        <span>Procesos electorales</span>
                    </a>
                    <a href="candidatos.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-users w-5 h-5"></i>
                        <span>Candidatos</span>
                    </a>
                    <a href="fechas-y-periodos.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-calendar-alt w-5 h-5"></i>
                        <span>Fechas y Periodos</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 p-3 rounded-lg bg-sidebar-btn-active text-gray-800 font-medium shadow-md">
                        <i class="fas fa-chart-bar w-5 h-5 text-custom-dark-button"></i>
                        <span>Resultados</span>
                    </a>
                </nav>
            </div>

            <div class="mt-8">
                <a href="#" id="btnCerrarSesion"
                    class="w-full py-3 bg-blue-400 text-white font-semibold rounded-lg hover:bg-blue-500 transition duration-150 shadow-md flex justify-center">
                        Cerrar Sesión
                </a>
            </div>
        </div>

        <main class="flex-1 p-8 md:p-12 ml-sidebar-width">
            <h1 class="text-4xl font-serif text-main-title mb-10 border-b pb-4 text-center md:text-left">
                Resultados de las votaciones
            </h1>

            <div class="w-full max-w-2xl mx-auto space-y-6">
                <!-- Filtro de procesos -->
                <div class="relative mb-6">
                    <input type="text" id="filter-input" placeholder="Filtrar por Proceso" 
                        class="w-full p-3 border border-gray-300 rounded-lg cursor-pointer" readonly onclick="toggleFilterList()">
                    <div id="filter-process-list" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl hidden"></div>
                </div>

                <!-- Gráfico de pastel -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-custom-dark-button">
                    <h3 class="text-xl font-semibold text-custom-dark-button mb-4 border-b pb-2">
                        Distribución de Votos (%)
                        (<span id="current-process-name"></span>)
                    </h3>

                    <div class="flex flex-col md:flex-row items-center justify-around gap-6">
                        <div class="w-40 h-40 flex-shrink-0">
                            <canvas id="vote-chart" width="160" height="160" class="mx-auto"></canvas>
                        </div>
                        <div id="chart-legend" class="space-y-2 text-left"></div>
                    </div>
                </div>

                <!-- Gráfico de barras -->
                <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border-t-4 border-custom-dark-button">
                    <h3 class="text-xl font-semibold text-custom-dark-button mb-4 border-b pb-2">
                        Votos por Candidato
                    </h3>
                    <canvas id="vote-bar-chart" width="500"></canvas>
                </div>
            </div>
        </main>

    </div>

    <script>
    const colores = ['#dc2626', '#4f6a73', '#6b21a8', '#f59e0b', '#10b981', '#3b82f6'];

    function drawBarChart(data) {
        const canvas = document.getElementById('vote-bar-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        // Configuración
        const barHeight = 30;
        const gap = 20;
        const leftPadding = 200;   // espacio para nombres
        const rightPadding = 60;   // espacio para número de votos
        const totalHeight = data.length * (barHeight + gap) + gap;

        canvas.height = totalHeight; // ajustar altura automáticamente
        const width = canvas.width;
        ctx.clearRect(0, 0, width, totalHeight);

        const maxVotes = Math.max(...data.map(d => d.votes)) || 1;

        // Dibujar línea vertical (eje Y)
        ctx.beginPath();
        ctx.moveTo(leftPadding, 0);
        ctx.lineTo(leftPadding, totalHeight);
        ctx.strokeStyle = "#000"; // color negro
        ctx.lineWidth = 2;
        ctx.setLineDash([]); // línea sólida
        ctx.stroke();

        // Dibujar línea horizontal (eje X)
        ctx.beginPath();
        ctx.moveTo(leftPadding, totalHeight - gap);
        ctx.lineTo(width - rightPadding, totalHeight - gap);
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.stroke();

        data.forEach((item, index) => {
            const y = gap + index * (barHeight + gap);
            const barWidth = ((width - leftPadding - rightPadding) * item.votes) / maxVotes;

            // Línea guía punteada de referencia
            ctx.beginPath();
            ctx.moveTo(leftPadding, y + barHeight / 2);
            ctx.lineTo(width - rightPadding, y + barHeight / 2);
            ctx.strokeStyle = "#d1d5db"; // gris suave
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]); // reset

            // Dibujar barra
            ctx.fillStyle = colores[index % colores.length];
            ctx.fillRect(leftPadding, y, barWidth, barHeight);

            // Nombre candidato
            ctx.fillStyle = "#000";
            ctx.font = "14px Arial";
            ctx.textAlign = "right";
            ctx.fillText(item.candidate, leftPadding - 10, y + barHeight / 2 + 5);

            // Número de votos
            ctx.textAlign = "left";
            ctx.fillText(item.votes, leftPadding + barWidth + 10, y + barHeight / 2 + 5);
        });
    }

    // Función updateResults
    function updateResults(processName, result) {
        document.getElementById('current-process-name').textContent = processName;

        // Gráfico pastel
        drawPieChart(result.votos);

        // Gráfico barras
        const votosNumeros = result.votos.map(v => ({ candidate: v.candidate, votes: v.votes }));
        drawBarChart(votosNumeros);

        // Leyenda
        const legendContainer = document.getElementById('chart-legend');
        let legendHtml = '';
        result.votos.forEach((voto, index) => {
            const color = colores[index % colores.length];
            legendHtml += `
                <div class="flex items-center space-x-2 text-sm text-gray-700">
                    <span class="w-3 h-3 rounded-full" style="background-color: ${color};"></span>
                    <span class="font-medium">${voto.candidate}:</span>
                    <span>${voto.percentage}%</span>
                </div>
            `;
        });
        legendContainer.innerHTML = legendHtml;
    }
</script>





    <script type="module">
        import { cargarNombreAdmin, protegerPagina, cerrarSesion } from "./js/admin.js";
        protegerPagina();
        cargarNombreAdmin();
        document.getElementById("btnCerrarSesion")?.addEventListener("click", cerrarSesion);
    </script>
</body>
</html>