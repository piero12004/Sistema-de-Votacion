<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Procesos Electorales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-bg': '#f3f4f6', 
                        'sidebar-bg': '#3c676e', 
                        'main-title': '#2e4963', 
                        'new-process-btn': '#a3e6ff', 
                        'sidebar-btn-active': '#e5e7eb', 
                        'custom-dark-button': '#355b63',
                        'table-header-bg': '#3c676e',
                        'active-filter-bg': '#f0f3f6',
                        'aprobado': '#4CAF50',       
                        'revision': '#FFC107',       
                        'rechazado': '#F44336',      
                        'observacion': '#2196F3',    
                    },
                    spacing: {
                        'sidebar-width': '16rem', 
                    }
                }
            }
        }

        function openEditModal() {
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function handleRegister(event) {
            event.preventDefault();
            console.log("Proceso registrado. Cerrando modal de creación.");
            closeCreationModal();
        }
        
        function handleEdit(event) {
            event.preventDefault();
            console.log("Proceso editado. Cerrando modal de edición.");
            closeEditModal();
        }
    </script>
</head>
<body class="bg-main-bg">
    <div class="flex min-h-screen">
        <div class="w-sidebar-width bg-sidebar-bg text-white flex flex-col justify-between p-4 fixed h-full shadow-lg">
            <div>
                <div class="flex items-center space-x-3 mb-8 border-b border-gray-500 pb-4">
                    <div class="p-2 rounded-full bg-white text-sidebar-bg">
                        <i class="fas fa-user text-xl"></i>
                    </div>
                    <span id="nombreAdmin" class="text-xl font-semibold">Usuario</span>
                </div>

                <nav class="space-y-3">
                    <a href="principal.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-home w-5 h-5"></i>
                        <span>Panel principal</span>
                    </a>
                    
                    <a href="procesos-electorales.html" class="flex items-center space-x-3 p-3 rounded-lg bg-sidebar-btn-active text-gray-800 font-medium shadow-md">
                        <i class="fas fa-clipboard-list w-5 h-5 text-custom-dark-button"></i>
                        <span>Procesos electorales</span>
                    </a>
                    
                    <a href="candidatos.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-users w-5 h-5"></i>
                        <span>Candidatos</span>
                    </a>
                    <a href="fechas-y-periodos.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-calendar-alt w-5 h-5"></i>
                        <span>Fechas y Periodos</span>
                    </a>
                    <a href="resultados.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-white">
                        <i class="fas fa-chart-bar w-5 h-5"></i>
                        <span>Resultados</span>
                    </a>
                </nav>
            </div>

            <div class="mt-8">
                <a href="login.html" class="w-full py-3 bg-blue-400 text-white font-semibold rounded-lg hover:bg-blue-500 transition duration-150 shadow-md flex justify-center">
                    Cerrar Sesion
                </a>
            </div>
        </div>
        
        <main class="flex-1 p-8 md:p-12 ml-sidebar-width">
            <h1 class="text-3xl font-serif text-main-title text-center mb-8">
                Procesos Electorales
            </h1>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <button 
                    onclick="openCreationModal()" 
                    class="py-2 px-4 bg-new-process-btn text-main-title font-bold rounded-lg shadow-md hover:bg-opacity-80 transition duration-150 w-full md:w-auto">
                    Crear Nuevo Proceso
                </button>

                <div class="relative w-full md:w-72 mb-4 flex gap-2">
                    <!-- Input para filtrar por nombre -->
                    <input 
                        type="text" 
                        id="filtroNombre"
                        placeholder="Buscar por nombre..."
                        class="w-full py-2 px-4 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-dark-button">

                    <!-- Select para filtrar por estado -->
                    <select id="filtroEstado" class="py-2 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-dark-button">
                        <option value="">Todos los estados</option>
                        <option value="Activo">Activo</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Terminado">Terminado</option>
                        <option value="Observacion">En observación</option>
                    </select>
                </div>
            </div>

            <!-- 2. Tabla de Procesos -->
            <div class="bg-white rounded-xl shadow-lg overflow-x-auto mb-10">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-table-header-bg">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Avance (%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Votos</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-procesos" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-main-title border-b pb-2 mb-4">
                        Proceso Seleccionado
                    </h3>

                    <dl class="space-y-2 text-gray-700">
                        <div class="flex">
                            <dt class="font-semibold w-1/4">Nombre del Proceso:</dt>
                            <dd class="w-3/4">Elecciones Centro de Estudiantes</dd>
                        </div>
                        <div class="flex">
                            <dt class="font-semibold w-1/4">ID:</dt>
                            <dd class="w-3/4">111222333</dd>
                        </div>
                        <div class="flex">
                            <dt class="font-semibold w-1/4">Tipo:</dt>
                            <dd class="w-3/4">Presencial</dd>
                        </div>
                        <div class="flex">
                            <dt class="font-semibold w-1/4">Estado:</dt>
                            <dd class="w-3/4 text-green-600 font-semibold">Activo</dd>
                        </div>
                        <div class="flex">
                            <dt class="font-semibold w-1/4">Fecha:</dt>
                            <dd class="w-3/4">20/11/2025</dd>
                        </div>
                        <div class="flex">
                            <dt class="font-semibold w-1/4">Avance (%):</dt>
                            <dd class="w-3/4">55%</dd>
                        </div>
                        <div class="flex">
                            <dt class="font-semibold w-1/4">Votos:</dt>
                            <dd class="w-3/4">1250</dd>
                        </div>
                    </dl>
                    
                    <div class="mt-8 flex space-x-4 justify-start">
                        <button 
                            onclick="openEditModal()"
                            class="py-2 px-6 bg-custom-dark-button text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                            Editar
                        </button>
                        <button class="py-2 px-6 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150">
                            Archivar
                        </button>
                        <button class="py-2 px-6 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                            Eliminar
                        </button>
                    </div>
                </div>

            </div>
            
        </main>
        
    </div>

    <!-- Creacion de nuevo proceso -->
    <div 
        id="creation-modal" 
        class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden"
        onclick="closeCreationModal()">
        
        <div 
            class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-100 mx-4"
            onclick="event.stopPropagation()">
            
            <h2 class="text-2xl font-serif text-main-title text-center mb-6 border-b pb-3">
                Creación de un nuevo proceso electoral
            </h2>
            
            <form onsubmit="handleRegister(event)">
                <div class="mb-4">
                    <label for="name_create" class="block text-sm font-medium text-gray-700">Nombre:</label>
                    <input type="text" id="name_create" name="name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-dark-button focus:border-custom-dark-button" required>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de proceso:</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center justify-center gap-2 border border-gray-300 rounded-md py-2 cursor-pointer hover:bg-gray-100 transition">
                            <input type="radio" name="tipo" value="presencial" 
                                class="text-custom-dark-button focus:ring-custom-dark-button" required>
                            <span>Presencial</span>
                        </label>

                        <label class="flex items-center justify-center gap-2 border border-gray-300 rounded-md py-2 cursor-pointer hover:bg-gray-100 transition">
                            <input type="radio" name="tipo" value="online" 
                                class="text-custom-dark-button focus:ring-custom-dark-button" required>
                            <span>Online</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="start_date_create" class="block text-sm font-medium text-gray-700">Fecha de Inicio:</label>
                    <input type="date" id="start_date_create" name="start_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-dark-button focus:border-custom-dark-button" required>
                </div>

                <div class="mb-6">
                    <label for="end_date_create" class="block text-sm font-medium text-gray-700">Fecha de Cierre:</label>
                    <input type="date" id="end_date_create" name="end_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-dark-button focus:border-custom-dark-button" required>
                </div>

                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado:</label>
                    <div class="flex space-x-4 justify-start">
                        <div class="flex items-center">
                            <input type="radio" id="status_approved_c" name="status_create" value="aprobado" class="hidden peer" checked>
                            <label for="status_approved_c" class="px-4 py-2 text-white text-xs font-bold rounded-lg cursor-pointer bg-aprobado hover:opacity-90 transition duration-150 peer-checked:ring-2 peer-checked:ring-aprobado peer-checked:ring-offset-2">
                                Aprobado
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="status_review_c" name="status_create" value="revision" class="hidden peer">
                            <label for="status_review_c" class="px-4 py-2 text-gray-800 text-xs font-bold rounded-lg cursor-pointer bg-revision hover:opacity-90 transition duration-150 peer-checked:ring-2 peer-checked:ring-revision peer-checked:ring-offset-2">
                                En Revisión
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="status_rejected_c" name="status_create" value="rechazado" class="hidden peer">
                            <label for="status_rejected_c" class="px-4 py-2 text-white text-xs font-bold rounded-lg cursor-pointer bg-rechazado hover:opacity-90 transition duration-150 peer-checked:ring-2 peer-checked:ring-rechazado peer-checked:ring-offset-2">
                                Rechazado
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-start space-x-4">
                    <button type="submit" class="py-2 px-6 bg-custom-dark-button text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                        Registrar Nuevo Proceso
                    </button>
                    <button type="button" onclick="closeCreationModal()" class="py-2 px-6 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-150">
                        Rechazar Proceso
                    </button>
                </div>
            </form>

        </div>
    </div>

    <!-- Edicion de datos -->
    <div 
        id="edit-modal" 
        class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden"
        onclick="closeEditModal()">
        
        <div 
            class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-100 mx-4"
            onclick="event.stopPropagation()">
            
            <h2 class="text-2xl font-serif text-main-title text-center mb-6 border-b pb-3">
                Edición de Datos
            </h2>
            
            <form onsubmit="handleEdit(event)">
                
                <div class="mb-4">
                    <label for="name_edit" class="block text-sm font-medium text-gray-700">Nombre:</label>
                    <input type="text" id="name_edit" name="name" value="Elecciones Estudiantes" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-dark-button focus:border-custom-dark-button" required>
                </div>

                <div class="mb-4">
                    <label for="type_edit" class="block text-sm font-medium text-gray-700">Tipo:</label>
                    <input type="text" id="type_edit" name="type" value="Presencial" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-dark-button focus:border-custom-dark-button" required>
                </div>

                <div class="mb-4">
                    <label for="date_edit" class="block text-sm font-medium text-gray-700">Fecha:</label>
                    <input type="text" id="date_edit" name="date" value="20/11/2025" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-custom-dark-button focus:border-custom-dark-button" required>
                </div>
                
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado:</label>
                    <div class="flex space-x-2 justify-start flex-wrap gap-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="status_approved_e" name="status_edit" value="aprobado" class="hidden peer" checked>
                            <label for="status_approved_e" class="px-3 py-1.5 text-white text-xs font-bold rounded-lg cursor-pointer bg-aprobado hover:opacity-90 transition duration-150 peer-checked:ring-2 peer-checked:ring-aprobado peer-checked:ring-offset-2">
                                Aprobado
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="status_review_e" name="status_edit" value="revision" class="hidden peer">
                            <label for="status_review_e" class="px-3 py-1.5 text-gray-800 text-xs font-bold rounded-lg cursor-pointer bg-revision hover:opacity-90 transition duration-150 peer-checked:ring-2 peer-checked:ring-revision peer-checked:ring-offset-2">
                                En Revisión
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="status_rejected_e" name="status_edit" value="rechazado" class="hidden peer">
                            <label for="status_rejected_e" class="px-3 py-1.5 text-white text-xs font-bold rounded-lg cursor-pointer bg-rechazado hover:opacity-90 transition duration-150 peer-checked:ring-2 peer-checked:ring-rechazado peer-checked:ring-offset-2">
                                Rechazado
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="status_observacion_e" name="status_edit" value="observacion" class="hidden peer">
                            <label for="status_observacion_e" class="px-3 py-1.5 text-white text-xs font-bold rounded-lg cursor-pointer bg-observacion hover:opacity-90 transition duration-150 peer-checked:ring-2 peer-checked:ring-observacion peer-checked:ring-offset-2">
                                En observación
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-start space-x-4">
                    <button type="submit" class="py-2 px-6 bg-custom-dark-button text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                        Confirmar Cambios
                    </button>
                    <button type="button" onclick="closeEditModal()" class="py-2 px-6 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                        Cancelar Cambios
                    </button>
                </div>
            </form>

        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const token = localStorage.getItem("tokenAdmin");

            // Detectar modales
            const modal1 = document.getElementById("modalProceso"); // principal.html
            const modal2 = document.getElementById("creation-modal"); // procesos-electorales.html

            let modal, modalContent, form;

            if (modal1) {
                // principal.html
                modal = modal1;
                modalContent = document.getElementById("modalContenido");
                form = document.getElementById("formProceso");

                const btnAbrir = document.getElementById("btnAbrirModal");
                btnAbrir?.addEventListener("click", () => {
                    modal.classList.remove("hidden");
                    setTimeout(() => modalContent.classList.remove("opacity-0", "scale-90"), 10);
                });

                document.getElementById("btnCerrarModal")?.addEventListener("click", () => {
                    modalContent.classList.add("opacity-0", "scale-90");
                    setTimeout(() => modal.classList.add("hidden"), 200);
                });

            } else if (modal2) {
                // procesos-electorales.html
                modal = modal2;
                modalContent = modal2.querySelector("div > div");
                form = modal2.querySelector("form");

                // Abrir modal
                window.openCreationModal = () => {
                    modal.classList.remove("hidden");
                    setTimeout(() => {
                        modalContent.classList.remove("opacity-0", "scale-90");
                    }, 10);
                };

                // Cerrar modal
                window.closeCreationModal = () => {
                    modalContent.classList.add("opacity-0", "scale-90");
                    setTimeout(() => modal.classList.add("hidden"), 200);
                };
            }

            if (!form) return; // no hay nada que procesar

            // =============================
            // Obtener valores según página
            // =============================

            const getFields = () => {
                if (modal1) {
                    return {
                        nombre: document.getElementById("nombre")?.value || "",
                        tipo: document.querySelector("input[name='tipo']:checked")?.value || "",
                        estado: document.getElementById("estado")?.value || "",
                        fechaInicio: document.getElementById("fechaInicio")?.value || "",
                        fechaFin: document.getElementById("fechaFin")?.value || "",
                    };
                }

                return {
                    nombre: document.getElementById("name_create")?.value || "",
                    tipo: document.querySelector("input[name='tipo']:checked")?.value || "",
                    estado: document.querySelector("input[name='status_create']:checked")?.value || "",
                    fechaInicio: document.getElementById("start_date_create")?.value || "",
                    fechaFin: document.getElementById("end_date_create")?.value || "",
                };
            };

            // =============================
            // Normalizar valores
            // =============================

            const normalizar = (valor, tipo) => {
                if (tipo === "tipo") {
                    return valor === "presencial" ? "Presencial" : "Online";
                }
                if (tipo === "estado") {
                    if (valor === "aprobado" || valor === "activo") return "Activo";
                    if (valor === "revision" || valor === "pendiente") return "Pendiente";
                    return "Observacion";
                }
                return valor;
            };

            // =============================
            // Enviar formulario
            // =============================

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const campos = getFields();

                const body = {
                    nombre: campos.nombre,
                    tipo: normalizar(campos.tipo, "tipo"),
                    estado: normalizar(campos.estado, "estado"),
                    fechaInicio: campos.fechaInicio,
                    fechaFin: campos.fechaFin,
                };

                try {
                    const res = await fetch("https://sistema-de-votacion-gjzq.onrender.com/api/proceso", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            ...(token ? { "Authorization": `Bearer ${token}` } : {})
                        },
                        body: JSON.stringify(body)
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert("✔ Proceso electoral creado con éxito");

                        modalContent.classList.add("opacity-0", "scale-90");
                        setTimeout(() => modal.classList.add("hidden"), 200);

                        location.reload();
                    } else {
                        alert("❌ Error: " + (data.error || "No se pudo crear el proceso"));
                    }

                } catch (err) {
                    console.error(err);
                    alert("❌ Error de conexión con el servidor");
                }
            });

        });
    </script>

    <script>
        const API_URL = "https://sistema-de-votacion-gjzq.onrender.com/api/proceso";
        let procesosGlobal = [];

        async function cargarProcesos() {
            try {
                const res = await fetch(API_URL);
                const procesos = await res.json();

                procesosGlobal = procesos; // guardamos todos los procesos
                renderizarProcesos(procesosGlobal);
            } catch (err) {
                console.error("Error cargando procesos:", err);
            }
        }

        function renderizarProcesos(procesos) {
            const tbody = document.getElementById("tabla-procesos");
            tbody.innerHTML = "";

            procesos.forEach(p => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 cursor-pointer">
                        <td class="px-6 py-4 whitespace-nowrap">${p.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">${p._id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${p.tipo}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${
                            p.estado === "Activo"
                                ? "text-green-600"
                                : p.estado === "Pendiente"
                                ? "text-yellow-600"
                                : p.estado === "Terminado"
                                ? "text-gray-600"
                                : "text-blue-600"
                        } font-semibold">${p.estado}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${p.fechaInicio ? new Date(p.fechaInicio).toLocaleDateString("es-PE") : "-"}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${p.progreso}%</td>
                        <td class="px-6 py-4 whitespace-nowrap">${p.totalVotos}</td>
                    </tr>
                `;
            });
        }

        // Filtrar al escribir o cambiar estado
        document.getElementById("filtroNombre").addEventListener("input", filtrarProcesos);
        document.getElementById("filtroEstado").addEventListener("change", filtrarProcesos);

        function filtrarProcesos() {
            const nombre = document.getElementById("filtroNombre").value.toLowerCase();
            const estado = document.getElementById("filtroEstado").value;

            const filtrados = procesosGlobal.filter(p => {
                const coincideNombre = p.nombre.toLowerCase().includes(nombre);
                const coincideEstado = estado ? p.estado === estado : true;
                return coincideNombre && coincideEstado;
            });

            renderizarProcesos(filtrados);
        }

        // Llamada inicial
        cargarProcesos();
    </script>

    <script type="module">
        import { cargarNombreAdmin } from "./js/admin.js";
        cargarNombreAdmin();
    </script>
</body>
</html>